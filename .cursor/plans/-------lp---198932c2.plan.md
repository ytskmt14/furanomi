<!-- 198932c2-1609-483f-82e1-0f504f42f0a0 01024552-f04d-42a7-bfc6-c3fa4c2aea12 -->
# 店舗拡張機能設定機能の追加

## 概要

店舗ごとに拡張機能のON/OFFを設定できる仕組みを実装。基本機能（空き状況可視化）は全店舗で提供、追加機能は店舗ごとに制御可能（将来的に課金対象）。利用者向け機能は無料で提供。

## 実装内容

### Phase2での機能設定

1. **予約機能**: 店舗ごとにON/OFF設定（システム管理者が制御）
2. **プッシュ通知（店舗管理者向け）**: 予約機能ONの店舗のみ利用可能
3. **プッシュ通知（利用者向け）**: 全店舗で利用可能（利用者向けは無料）
4. **利用者認証**: 利用者アプリの機能なので全適用（無料）

### データベース

- **新規テーブル**: `shop_feature_settings` (EAV方式で設計、拡張性重視)
- `id` (UUID, PRIMARY KEY)
- `shop_id` (UUID, REFERENCES shops(id) ON DELETE CASCADE, NOT NULL)
- `feature_name` (VARCHAR(50), NOT NULL) -- 'reservation', 'coupon', 'loyalty_points', etc.
- `enabled` (BOOLEAN, NOT NULL, DEFAULT false)
- `created_at` (TIMESTAMPTZ, NOT NULL, DEFAULT NOW())
- `updated_at` (TIMESTAMPTZ, NOT NULL, DEFAULT NOW())
- UNIQUE制約: (shop_id, feature_name) -- 店舗ごと、機能ごとに1レコードのみ
- インデックス: (shop_id, feature_name) で高速検索

**設計の利点**:

- ✅ 新機能追加時にテーブル構造変更が不要（feature_nameを追加するだけ）
- ✅ 各機能を独立してON/OFF可能（例: 予約OFF、クーポンON）
- ✅ 将来的に機能ごとの追加設定（メタデータ）をJSONBカラムで拡張可能
- ✅ クエリパターン: `SELECT enabled FROM shop_feature_settings WHERE shop_id = $1 AND feature_name = 'reservation'`

### バックエンドAPI

- `GET /api/shops/:shopId/features` - 店舗の機能設定取得
- `PUT /api/shops/:shopId/features` - 店舗の機能設定更新（システム管理者のみ）
- `GET /api/system/shops/:shopId/features` - システム管理者向け詳細取得

### フロントエンド

#### システム管理者画面

- `ShopsManagement` に機能設定列を追加
- 各店舗の機能設定をトグルでON/OFF可能
- または専用の「機能設定」タブ/モーダルを追加

#### 店舗管理者画面

- `Settings` または `Dashboard` に現在有効な機能の一覧を表示（参照のみ）
- 無効な機能は表示しない、またはグレーアウト表示

### 機能制御ロジック

#### 予約機能

- `shop_feature_settings.reservation_enabled = true` の場合のみ有効
- 予約作成 hibst時、予約管理画面アクセス時にチェック
- 無効な場合は「この店舗では予約機能をご利用いただけません」と表示

#### プッシュ通知（店舗管理者向け）

- 予約機能がONの店舗のみ購読可能
- 予約作成時の通知送信は予約機能ONの店舗のみ

#### フロントエンドでの条件分岐

- 店舗詳細画面の「予約する」ボタン表示制御
- 店舗管理者の予約管理画面の表示制御
- システム管理者の機能設定UI

## ファイル構成

### バックエンド

- `backend/database/migrations/009_add_shop_feature_settings.sql`
- `backend/src/routes/shopFeatures.ts` (新規)
- `backend/src/routes/shops.ts` (更新: 機能チェック用ヘルパー追加)

### フロントエンド

- `frontend/src/components/systemAdmin/ShopFeatureSettings.tsx` (新規、またはShopsManagementに統合)
- `frontend/src/components/shopManager/FeatureStatus.tsx` (新規、表示専用)
- `frontend/src/services/api.ts` (機能設定API呼び出し追加)
- `frontend/src/components/ShopDetail.tsx` (予約ボタン表示制御)
- `frontend/src/components/shopManager/ShopManagerLayout.tsx` (予約管理リンク表示制御)
- `frontend/src/components/shopManager/ReservationManagement.tsx` (機能チェック追加)

## マイルストーン

1. データベースマイグレーション作成
2. バックエンドAPI実装（取得・更新）
3. システム管理者画面に機能設定UI追加
4. 店舗管理者画面に機能ステータス表示追加
5. 予約機能のON/OFF制御実装
6. プッシュ通知の条件付き有効化
7. テスト・動作確認

### To-dos

- [ ] shop_feature_settingsテーブルのマイグレーションファイル作成
- [ ] 店舗機能設定取得API実装（GET /api/shops/:shopId/features）
- [ ] 店舗機能設定更新API実装（PUT /api/shops/:shopId/features、システム管理者のみ）
- [ ] システム管理者画面に機能設定UI追加（トグルボタン）
- [ ] 店舗管理者画面に機能ステータス表示追加（参照のみ）
- [ ] 予約機能のON/OFF制御実装（店舗詳細画面、予約管理画面）
- [ ] プッシュ通知の条件付き有効化（予約機能ONの店舗のみ）