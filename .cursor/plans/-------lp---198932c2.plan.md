<!-- 198932c2-1609-483f-82e1-0f504f42f0a0 cf7bdb41-9ab4-4868-8e68-0814ccc31d6e -->
# User Authentication System Implementation (Email Only)

## OpenSpec Workflow

1. **Change Proposal作成**: `changes/add-user-authentication/` に以下を作成

   - `proposal.md`: 利用者認証機能の目的・変更内容・影響範囲
   - `tasks.md`: 実装タスクのチェックリスト
   - `specs/user-authentication/spec.md`: 認証機能の要件定義（ADDED Requirements）

2. **Validation**: `openspec validate add-user-authentication --strict`

3. **承認後に実装開始**

## Implementation Plan

### Phase 1: Database Schema

**Migration File**: `backend/database/migrations/006_add_users_table.sql`

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  name VARCHAR(100) NOT NULL,
  phone VARCHAR(20),
  reset_token VARCHAR(255),
  reset_token_expires_at TIMESTAMP WITH TIME ZONE,
  last_login_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### Phase 2: Backend API

**New File**: `backend/src/routes/userAuth.ts`

エンドポイント:

- `POST /api/user-auth/register` - メール登録
- `POST /api/user-auth/login` - メールログイン
- `POST /api/user-auth/logout` - ログアウト
- `GET /api/user-auth/me` - ユーザー情報取得
- `POST /api/user-auth/password-reset/request` - パスワードリセット要求
- `POST /api/user-auth/password-reset/confirm` - パスワードリセット実行

**Dependencies**: 既存の `bcryptjs`, `jsonwebtoken` を使用

### Phase 3: Frontend - Authentication Context

**New File**: `frontend/src/contexts/AuthContext.tsx`

ユーザー認証状態を管理:

- `user`: 現在のユーザー情報
- `login()`, `logout()`, `register()`
- `isAuthenticated`: 認証状態
- Context Provider で App 全体をラップ

### Phase 4: Frontend - UI Components

**New Files**:

- `frontend/src/components/auth/LoginModal.tsx` - ログインモーダル
- `frontend/src/components/auth/RegisterModal.tsx` - 登録モーダル
- `frontend/src/components/auth/PasswordResetModal.tsx` - パスワードリセット
- `frontend/src/components/auth/UserProfile.tsx` - プロフィール表示
- `frontend/src/components/auth/ProtectedRoute.tsx` - 認証が必要なルート

**Features**:

- メール/パスワード入力フォーム
- フォームバリデーション
- エラーハンドリング

### Phase 5: Frontend - Integration

**Modified Files**:

- `frontend/src/App.tsx`:
  - `AuthProvider` で全体をラップ
  - `/user/profile` ルート追加

- `frontend/src/components/Layout.tsx`:
  - ヘッダーに「ログイン」ボタン追加（未認証時）
  - ヘッダーにユーザー名＋「ログアウト」表示（認証時）

### Phase 6: API Service Update

**Modified File**: `frontend/src/services/api.ts`

新しいメソッド追加:

- `registerUser(email, password, name, phone?)`
- `loginUser(email, password)`
- `logoutUser()`
- `getCurrentUser()`
- `requestPasswordReset(email)`
- `confirmPasswordReset(token, newPassword)`

## Key Files Summary

**Backend**:

- `backend/database/migrations/006_add_users_table.sql` (新規)
- `backend/src/routes/userAuth.ts` (新規)
- `backend/src/index.ts` (userAuth ルート追加)

**Frontend**:

- `frontend/src/contexts/AuthContext.tsx` (新規)
- `frontend/src/components/auth/*.tsx` (新規5ファイル)
- `frontend/src/services/api.ts` (メソッド追加)
- `frontend/src/App.tsx` (AuthProvider、ルート追加)
- `frontend/src/components/Layout.tsx` (ヘッダー修正)

## Notes

- JWT の payload に `role: 'user'` を追加して既存の shop_manager/system_admin と区別
- パスワードリセットはトークン生成のみ実装（メール送信は未実装）
- 認証後のリダイレクト先は `/user`
- OAuth連携（LINE/Google）は Phase 3 以降で実装予定

### To-dos

- [ ] OpenSpec change proposal作成 (proposal.md, tasks.md, spec.md)
- [ ] openspec validate実行と修正
- [ ] usersテーブルのマイグレーションファイル作成
- [ ] バックエンドAPI実装 (userAuth.ts)
- [ ] AuthContext作成（認証状態管理）
- [ ] 認証UI コンポーネント作成 (LoginModal, RegisterModal等)
- [ ] App.tsx と Layout.tsx の統合