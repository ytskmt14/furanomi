<!-- 198932c2-1609-483f-82e1-0f504f42f0a0 1709cf17-819f-4e2f-966e-53236bc306bd -->
# 予約作成時の店舗管理者向けプッシュ通知を追加

## スコープ

- **店舗管理者アプリのみ通知対象**（利用者側は対象外）
  - 注意: TASK-013は利用者アプリ向けのプッシュ通知（空き状況変更）を実装するため、こちらとは別機能
- 対象イベント: 予約の作成、承認、拒否（まずは作成を必須、承認/拒否は可能なら同時）
- PWAは既存のまま（オフライン/インストールバナー）
- 送信チャネル: Web Push (VAPID)。Phase2ブランチ上で実装し、mainへは未マージ
- 実装位置: TASK-013（利用者アプリ通知）に先行して実装

## 影響範囲と主要変更

- backend
  - DB: `push_subscriptions` テーブル新設（shop_manager紐づけ必須）
  - API: `/api/notifications/subscribe|unsubscribe|vapid-public-key` を復活
  - 予約API: `POST /api/reservations` 完了時に対象店舗の `shop_manager_id` の購読へ通知送信
  - 承認/拒否APIでも通知送信（任意）
- frontend (shop-manager)
  - 購読トグルUI（設定画面 or ヘッダー）
  - Service Worker既存 `sw.js` をプッシュ受信に対応（通知表示）
- 設定/運用
  - VAPIDキー生成・ENV設定（docsに手順追記）

## 具体的編集ポイント

- DB: 新規 `backend/database/migrations/00X_add_push_subscriptions.sql`
  ```sql
  CREATE TABLE push_subscriptions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    shop_manager_id UUID NOT NULL REFERENCES shop_managers(id) ON DELETE CASCADE,
    endpoint TEXT NOT NULL UNIQUE,
    p256dh TEXT NOT NULL,
    auth TEXT NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  );
  CREATE INDEX idx_push_subs_manager ON push_subscriptions(shop_manager_id);
  ```

- backend ルート: `backend/src/routes/notifications.ts`
  - `GET /vapid-public-key`（公開鍵返却）
  - `POST /subscribe`（manager認証→購読保存）
  - `POST /unsubscribe`（endpoint削除）
- backend 送信: `backend/src/routes/reservations.ts`
  - 予約作成後に `shop_manager_id` を特定し購読へ`web-push`で送信
  - 例メッセージ: `{ title: "新規予約", body: "◯◯さん 3名 / 30分以内", url: "/shop-manager/reservations" }`
- frontend (shop-manager)
  - `src/services/pushNotifications.ts` を復活: 公開鍵取得/購読・解除
  - `ShopManagerLayout` か設定画面にトグル追加（デフォルトOFF）
  - `public/sw.js` pushイベントで`showNotification`
- docs
  - `docs/PWA_PUSH_NOTIFICATION_SETUP.md` にVAPID生成とENV追記（.gitignore対象のまま）

## 実装前提

- Phase2ブランチ上で作業
- `VAPID_PUBLIC_KEY`, `VAPID_PRIVATE_KEY` をバックエンドENVで設定

## リリース/検証

- ローカルでVAPIDキー生成→ENV設定→購読→予約作成→通知受信確認
- 本番はPhase2リリース時にENV投入

## 注意点

- iOS Safariの通知可否（iOS 16.4+ PWA可）を考慮。最低限ブラウザ対応確認
- 失敗時のリトライ/期限切れエンドポイントのクリーンアップはBest Effort（任意）

### To-dos

- [ ] push_subscriptionsテーブル追加のDBマイグレーション作成
- [ ] 通知API（subscribe/unsubscribe/public-key）を追加
- [ ] 予約作成後に店舗管理者へプッシュ通知送信
- [ ] 予約承認/拒否時にも通知送信（任意）
- [ ] 店舗管理者向け購読トグルUIを追加
- [ ] sw.jsでpush受信し通知表示
- [ ] VAPIDキー生成とENV設定手順をdocsに追記