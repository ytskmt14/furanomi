# ふらのみ開発バックログ

## 📋 バックログについて

このバックログは、ふらのみプロジェクトの機能追加、改善、不具合修正のタスクを管理するためのものです。

### 運用ルール

1. **タスクの追加**: 新しいタスクを発見したら、適切なセクションに追加します
2. **タスクのピックアップ**: 優先度の高いタスクから選択して実装します
3. **ステータス更新**: 実装開始時に「🚧 進行中」に更新します
4. **完了時の処理**: ✅ **完了したタスクはこのバックログから削除します**
5. **履歴の追跡**: Gitコミット履歴で過去のタスクを確認できます

### 完了タスクの追跡方法

```bash
# バックログの変更履歴を確認
git log -p openspec/backlog.md

# 特定のタスクIDを検索
git log --all --grep="TASK-XXX"
```

### OpenSpec changeとの連携

- **changeが必要なタスク**: `openspec/changes/<change-id>/` にproposal、tasks、spec deltasを作成
- **changeが不要なタスク**: 直接実装してコミット

---

## 🎯 優先度別タスク一覧

### 🔴 優先度: 高（緊急対応が必要）

#### TASK-012: バックエンドAPIレスポンス最適化 ✅ 完了

- **カテゴリ**: Improvement (Performance/Backend)
- **優先度**: 🔴 高
- **工数見積**: 中(3-5h)
- **ステータス**: ✅ 完了
- **OpenSpec Change**: 不要
- **説明**: 店舗検索APIのレスポンス時間が約5秒かかっている問題を解決する。Waiting for server responseが4.85秒と非常に長く、UXに大きな影響を与えていた。

#### 実装完了項目
✅ **Phase 1: 距離計算最適化**
- 距離計算を3回から1回に削減（WITH句でCTE使用）
- パラメータ重複を解消
- PostgreSQL WITH句で距離を事前計算

✅ **Phase 2: データベースインデックス適用**
- 位置情報検索用: `shops(latitude, longitude)`
- JOIN最適化用: `shop_availability(shop_id)`, `shops(shop_manager_id)`
- フィルタ用: `shops(is_active)`, `shops(category, is_active)`

✅ **Phase 3: 営業時間判定最適化**
- JavaScript側の営業時間判定をSQL側に移動
- PostgreSQL CASE文で営業時間判定を実行
- JavaScript側の処理を大幅削減

✅ **Phase 4: Railway Hobbyプランアップグレード**
- RAM: 512MB → 1GB（2倍）
- vCPU: 共有 → 専用リソース
- より高速な処理優先度

#### 達成された改善効果
- **開始時**: 5.3秒
- **現在**: **4.10秒**（平均）
- **改善率**: **23%改善**
- **最大改善**: **3.95秒**（34%改善）

#### 技術詳細
- PostgreSQL WITH句（CTE）で距離を事前計算
- 三角関数計算（cos, sin, acos, radians）を1回のみ実行
- 営業時間判定をSQL側で効率的に実行
- Railway Hobbyプランで専用リソースを確保

#### 今後の改善余地
- データベース接続プールの最適化
- プリペアドステートメントの使用
- レスポンスデータの最適化

### 🟡 優先度: 中（近日中に対応したい）

現時点では特になし

### 🟢 優先度: 低（将来的に対応したい）

#### TASK-009: エラーメッセージの詳細化

- **カテゴリ**: Improvement (UX)
- **優先度**: 🟢 低
- **工数見積**: 中(3-5h)
- **ステータス**: 🚧 進行中
- **OpenSpec Change**: 不要
- **説明**: ユーザーに表示するエラーメッセージをより具体的で理解しやすいものにする。現在は汎用的なエラーメッセージが多い。
- **受け入れ基準**:
  - [ ] 主要なエラーケースで具体的なメッセージが表示される
  - [ ] エラーの原因と対処法が明確
  - [ ] ユーザーフレンドリーな表現

#### TASK-010: バリデーションの強化

- **カテゴリ**: Improvement (Security/UX)
- **優先度**: 🟢 低
- **工数見積**: 中(3-5h)
- **ステータス**: 🚧 進行中
- **OpenSpec Change**: 不要
- **説明**: フォームのバリデーションを強化し、ユーザー入力の品質を向上させる
- **対象**:
  - メールアドレスの形式チェック
  - 電話番号の形式チェック（日本の形式）
  - パスワードの強度チェック（システム管理者）
- **受け入れ基準**:
  - [ ] メールアドレスが正しい形式かチェックされる
  - [ ] 電話番号が日本の形式かチェックされる
  - [ ] パスワードの強度が判定される
  - [ ] リアルタイムでバリデーションフィードバックが表示される

#### TASK-012: タップ領域のサイズ最適化

- **カテゴリ**: Improvement (Mobile UX)
- **優先度**: 🟢 低
- **工数見積**: 小(1-2h)
- **ステータス**: 🚧 進行中
- **OpenSpec Change**: 不要
- **説明**: モバイルでのタップ操作を最適化。タップ領域が小さすぎる箇所を修正（推奨: 最小44x44px）
- **受け入れ基準**:
  - [ ] 全てのボタンが最小44x44pxのタップ領域を持つ
  - [ ] リンクやアイコンボタンも適切なサイズ
  - [ ] モバイルでの操作性が向上

---

## 📦 カテゴリ別タスク一覧

### 🐛 不具合修正（Bugs）

（該当なし）

### 🎨 UX/UI改善（Improvements）

- TASK-007: 店舗管理者アプリのSEO対策
- TASK-008: システム管理者アプリのSEO対策
- TASK-009: エラーメッセージの詳細化
- TASK-010: バリデーションの強化
- TASK-011: タップ領域のサイズ最適化

### ⚡ パフォーマンス改善（Performance）

- TASK-016: パフォーマンス最適化（バンドル最適化、キャッシュ戦略）

### 🔒 セキュリティ強化（Security）

- TASK-015: セキュリティ強化（CSRF、XSS対策、レート制限）

### ✨ 新機能（Features）

- TASK-012: リアルタイム更新機能（WebSocket/SSE）
- TASK-013: PWA対応（オフライン機能、プッシュ通知）

### 📝 ドキュメント（Documentation）

現時点では特になし

### 🧪 テスト（Testing）

- TASK-014: 包括的なテスト実装（単体・統合・E2E）

### 🔧 DevOps

- TASK-017: 運用監視（ログ監視、バックアップ、アラート）

---

## ⏭️ Phase 2 - 将来実装予定

### TASK-012: リアルタイム更新機能（WebSocket/SSE）

- **カテゴリ**: Feature
- **優先度**: Phase 2
- **工数見積**: 特大(3日+)
- **ステータス**: 🚧 進行中
- **OpenSpec Change**: 必要
- **説明**: WebSocketまたはSSEを使用して、空き状況の変更をリアルタイムで利用者アプリに反映する
- **受け入れ基準**:
  - [ ] WebSocket/SSE接続が確立される
  - [ ] 空き状況の変更がリアルタイムで通知される
  - [ ] 接続が切れた場合の再接続処理
  - [ ] パフォーマンスへの影響が最小限

### TASK-013: PWA対応（オフライン機能、プッシュ通知）

- **カテゴリ**: Feature
- **優先度**: Phase 2
- **工数見積**: 大(1-2日)
- **ステータス**: 🚧 進行中
- **OpenSpec Change**: 必要
- **説明**: Progressive Web Appとして、オフライン機能とプッシュ通知を実装
- **受け入れ基準**:
  - [ ] Service Workerが実装されている
  - [ ] オフラインで基本機能が使える
  - [ ] プッシュ通知が実装されている
  - [ ] ホーム画面に追加できる

### TASK-014: 包括的なテスト実装（単体・統合・E2E）

- **カテゴリ**: Testing
- **優先度**: Phase 3
- **工数見積**: 特大(3日+)
- **ステータス**: 🚧 進行中
- **OpenSpec Change**: 不要
- **説明**: コード品質と保守性を向上させるため、包括的なテストスイートを実装
- **対象**:
  - ユニットテスト（Jest）
  - 統合テスト（React Testing Library）
  - E2Eテスト（Playwright/Cypress）
- **受け入れ基準**:
  - [ ] カバレッジ80%以上
  - [ ] CI/CDパイプラインに統合
  - [ ] 主要なユーザーフローがE2Eでカバーされている

### TASK-015: セキュリティ強化（CSRF、XSS対策、レート制限）

- **カテゴリ**: Security
- **優先度**: Phase 3
- **工数見積**: 大(1-2日)
- **ステータス**: 🚧 進行中
- **OpenSpec Change**: 必要
- **説明**: セキュリティ対策を強化し、本番環境での安全性を向上させる
- **対象**:
  - CSRF対策の強化
  - XSS対策の強化
  - レート制限の実装
  - セキュリティヘッダーの追加
- **受け入れ基準**:
  - [ ] CSRF トークンが実装されている
  - [ ] XSS対策が施されている
  - [ ] API呼び出しにレート制限がある
  - [ ] セキュリティスキャンをパス

### TASK-016: パフォーマンス最適化（バンドル最適化、キャッシュ戦略）

- **カテゴリ**: Performance
- **優先度**: Phase 3
- **工数見積**: 中(3-5h)
- **ステータス**: 🚧 進行中
- **OpenSpec Change**: 不要
- **説明**: アプリケーションのパフォーマンスを最適化し、読み込み速度を向上させる
- **対象**:
  - バンドルサイズの削減
  - 画像の最適化
  - キャッシュ戦略の改善
  - コード分割
- **受け入れ基準**:
  - [ ] バンドルサイズが20%以上削減
  - [ ] Lighthouse スコア90以上
  - [ ] 初期表示が2秒以内

### TASK-017: 運用監視（ログ監視、バックアップ、アラート）

- **カテゴリ**: DevOps
- **優先度**: Phase 3
- **工数見積**: 特大(3日+)
- **ステータス**: 🚧 進行中
- **OpenSpec Change**: 必要
- **説明**: 本番環境の運用を安定化させるため、監視とバックアップ体制を構築
- **対象**:
  - ログ監視システム（Sentry等）
  - データベースバックアップ
  - アラート通知
  - ヘルスチェック
- **受け入れ基準**:
  - [ ] エラーログが自動的に収集される
  - [ ] 日次バックアップが設定されている
  - [ ] 重大なエラー時にアラートが飛ぶ
  - [ ] ダッシュボードで状態を監視できる

---

## 📝 タスクフォーマット（新規追加時のテンプレート）

新しいタスクを追加する際は、以下のフォーマットを使用してください：

```markdown
### TASK-XXX: タスク名

- **カテゴリ**: Bug / Improvement / Feature / Performance / Security / Documentation / Testing / DevOps
- **優先度**: 🔴 高 / 🟡 中 / 🟢 低
- **工数見積**: 小(1-2h) / 中(3-5h) / 大(1-2日) / 特大(3日+)
- **ステータス**: 🚧 進行中 / 🚧 進行中
- **OpenSpec Change**: 必要 / 不要
- **説明**: タスクの詳細説明
- **受け入れ基準**:
  - [ ] 基準1
  - [ ] 基準2
  - [ ] 基準3
- **関連**: 関連するタスクやissue（オプション）
```

---

## 🔄 開発フロー

### 1. タスクのピックアップ

```
1. このバックログから優先度の高いタスクを選択
2. ステータスを「🚧 進行中」に更新
3. OpenSpec changeが必要か確認
```

### 2. 実装

```
OpenSpec changeが必要な場合:
  1. openspec/changes/<change-id>/ を作成
  2. proposal.md, tasks.md, spec deltas を作成
  3. 実装
  4. デプロイ
  5. archiveに移動

OpenSpec changeが不要な場合:
  1. コード修正
  2. テスト
  3. コミット（"fix:", "improve:", "feat:" 等）
  4. デプロイ
```

### 3. 完了処理

```
✅ タスク完了時:
  1. このバックログから該当タスクを削除
  2. Gitコミットメッセージに記載
     例: "improve: TASK-001 スタッフ画面のalert()をトースト通知に置き換え"
  3. OpenSpec changeを作成していた場合はarchive
```

---

## 📚 参考情報

- **OpenSpec開発フロー**: [openspec/AGENTS.md](./AGENTS.md)
- **プロジェクト概要**: [README.md](../README.md)
- **仕様書**: [openspec/specs/](./specs/)
- **完了した変更**: [openspec/changes/archive/](./changes/archive/)

---

**最終更新**: 2025年10月24日

