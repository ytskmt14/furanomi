# プッシュ通知機能の動作確認ガイド

## 前提条件

### 1. VAPID鍵の設定確認

バックエンドの環境変数にVAPID鍵が設定されていることを確認：

```bash
# バックエンドの環境変数を確認
cd backend
cat .env | grep VAPID
```

以下の環境変数が設定されている必要があります：
- `VAPID_PUBLIC_KEY`
- `VAPID_PRIVATE_KEY`

### 2. データベースマイグレーションの確認

プッシュ通知関連のテーブルが作成されていることを確認：

```sql
-- 店舗管理者向けプッシュ購読テーブル
SELECT * FROM push_subscriptions;

-- 利用者向けプッシュ購読テーブル
SELECT * FROM user_push_subscriptions;
```

### 3. ブラウザの通知許可

**重要**: プッシュ通知はブラウザの通知許可が必要です。

- Chrome/Edge: 設定 → プライバシーとセキュリティ → サイトの設定 → 通知
- Firefox: 設定 → プライバシーとセキュリティ → 権限 → 通知

---

## テスト1: 店舗管理者向けプッシュ通知（予約作成時）

### 目的
利用者が予約を作成したときに、店舗管理者にプッシュ通知が届くことを確認します。

### テスト手順

#### ステップ1: 店舗管理者でプッシュ通知を有効化

1. **店舗管理者アプリにログイン**
   ```
   URL: http://localhost:5173/shop-manager
   ログイン情報: シードデータの店舗管理者アカウント
   ```

2. **設定画面に移動**
   - 左メニューから「⚙️ 設定」をクリック
   - または `/shop-manager/settings` に直接アクセス

3. **プッシュ通知を有効化**
   - 「プッシュ通知」セクションで「通知を有効にする」ボタンをクリック
   - ブラウザの通知許可ダイアログが表示されたら「許可」をクリック
   - 「✓ プッシュ通知が有効です」と表示されることを確認

#### ステップ2: 予約機能を有効化（システム管理者）

1. **システム管理者アプリにログイン**
   ```
   URL: http://localhost:5173/system-admin
   ログイン情報: admin / admin123
   ```

2. **店舗管理画面で予約機能をON**
   - 「店舗管理」に移動
   - 対象店舗の「⚙️ 機能」ボタンをクリック
   - 「予約機能」をONにして保存

#### ステップ3: 利用者アプリで予約を作成

1. **利用者アプリにアクセス**
   ```
   URL: http://localhost:5173/user
   ```

2. **ログイン**
   - ヘッダーの「ログイン」からログイン
   - または新規登録

3. **予約を作成**
   - 店舗一覧から対象店舗を選択
   - 「予約する」ボタンをクリック
   - 人数と到着予定時間を選択して予約を確定

#### ステップ4: 通知の確認

1. **店舗管理者アプリ側で通知を確認**
   - 店舗管理者アプリが開いているブラウザで通知が表示されることを確認
   - 通知内容: 「新規予約 - [店舗名]: [人数]名 / [到着時間]」
   - 通知をクリックすると `/shop-manager/reservations` に遷移することを確認

2. **バックエンドログを確認**
   ```bash
   # バックエンドのコンソール出力を確認
   # 以下のようなログが表示されることを確認
   Push notification sent to shop manager [shop_manager_id]
   ```

### 期待される動作

- ✅ 予約作成時に店舗管理者にプッシュ通知が届く
- ✅ 通知をクリックすると予約管理画面に遷移する
- ✅ バックエンドログに通知送信成功のメッセージが表示される

---

## テスト2: 利用者向けプッシュ通知（お気に入り店舗の空き状況変更時）

### 目的
利用者がお気に入り登録した店舗の空き状況が変更されたときに、プッシュ通知が届くことを確認します。

### テスト手順

#### ステップ1: 利用者でプッシュ通知を有効化

1. **利用者アプリにログイン**
   ```
   URL: http://localhost:5173/user
   ```

2. **プッシュ通知を有効化**
   - ブラウザの通知許可を確認（既に許可済みの場合はスキップ）
   - 初回アクセス時に通知許可ダイアログが表示される場合がある
   - または、ブラウザの設定で通知を許可

   **注意**: 利用者アプリのプッシュ通知は、お気に入り店舗の空き状況変更時に自動的に送信されます。明示的な有効化UIは現時点ではありません（TASK-013で実装予定）。

#### ステップ2: 店舗をお気に入り登録

1. **店舗一覧から対象店舗を選択**
   - 店舗カードの星アイコン（☆）をクリック
   - または店舗詳細画面からお気に入り登録

2. **お気に入り登録を確認**
   - 星アイコンが塗りつぶし（★）になることを確認
   - プロフィール画面（`/user/profile`）の「お気に入り店舗」セクションに追加されることを確認

#### ステップ3: 店舗管理者で空き状況を更新

1. **店舗管理者アプリにログイン**
   ```
   URL: http://localhost:5173/shop-manager
   ```

2. **空き状況を更新**
   - 「空き状況更新」画面に移動
   - 空き状況を選択（例: 「空きあり」→「混雑」）
   - 「空き状況更新」ボタンをクリック

#### ステップ4: 通知の確認

1. **利用者アプリ側で通知を確認**
   - 利用者アプリが開いているブラウザで通知が表示されることを確認
   - 通知内容: 「空き状況が更新されました - [店舗名]: [新しい空き状況]」
   - 通知をクリックすると店舗詳細画面に遷移することを確認（実装されていない場合は、ユーザーアプリのトップページに遷移）

2. **バックエンドログを確認**
   ```bash
   # バックエンドのコンソール出力を確認
   # 以下のようなログが表示されることを確認
   # （エラーが出ていないことを確認）
   ```

### 期待される動作

- ✅ お気に入り店舗の空き状況が変更されると、お気に入り登録した利用者にプッシュ通知が届く
- ✅ 通知をクリックすると店舗詳細画面に遷移する（実装されていない場合はトップページ）
- ✅ 複数の利用者がお気に入り登録している場合、すべての利用者に通知が届く

---

## トラブルシューティング

### 通知が届かない場合

#### 1. VAPID鍵の確認

```bash
# バックエンドの環境変数を確認
cd backend
echo $VAPID_PUBLIC_KEY
echo $VAPID_PRIVATE_KEY

# または .env ファイルを確認
cat .env | grep VAPID
```

#### 2. Service Workerの確認

1. ブラウザの開発者ツールを開く（F12）
2. 「Application」タブ → 「Service Workers」を選択
3. Service Workerが登録されていることを確認
4. 状態が「activated」になっていることを確認

#### 3. プッシュ購読情報の確認

**店舗管理者向け**:
```sql
SELECT * FROM push_subscriptions;
```

**利用者向け**:
```sql
SELECT * FROM user_push_subscriptions;
```

購読情報が保存されていない場合、通知は送信されません。

#### 4. ブラウザの通知設定

- ブラウザの通知が許可されているか確認
- サイトの通知設定が「ブロック」になっていないか確認

#### 5. バックエンドログの確認

```bash
# バックエンドのコンソール出力を確認
# 以下のようなエラーメッセージが出ていないか確認
# - "VAPID keys not configured"
# - "No push subscription found"
# - "Failed to send push notification"
```

### よくあるエラー

#### エラー: "VAPID keys not configured"
- **原因**: 環境変数が設定されていない
- **解決策**: `.env` ファイルにVAPID鍵を設定

#### エラー: "No push subscription found"
- **原因**: プッシュ通知が有効化されていない
- **解決策**: 店舗管理者または利用者でプッシュ通知を有効化

#### エラー: "Failed to send push notification"
- **原因**: 購読情報が無効になっている、またはネットワークエラー
- **解決策**: 
  - プッシュ通知を再度有効化
  - バックエンドのログで詳細なエラーを確認

---

## デバッグ用の確認方法

### Service Workerデバッグページ

```
URL: http://localhost:5173/user/debug/sw
```

このページで以下を確認できます：
- Service Workerの登録状態
- Service Workerの状態（installing, waiting, active）
- キャッシュの状態
- プッシュ通知のイベントログ（ブラウザのコンソール）

### ブラウザの開発者ツール

1. **Applicationタブ**
   - Service Workers: Service Workerの状態
   - Cache Storage: キャッシュの内容
   - IndexedDB: データベースの内容

2. **Consoleタブ**
   - Service Workerからのログメッセージ
   - プッシュ通知のイベントログ

3. **Networkタブ**
   - `/api/notifications/subscribe` へのリクエストが成功しているか確認
   - `/api/notifications/vapid-public-key` へのリクエストが成功しているか確認

---

## 本番環境での確認

本番環境では、以下の点を確認してください：

1. **HTTPSが有効になっている**
   - プッシュ通知はHTTPS環境でのみ動作します（localhostは除く）

2. **環境変数が設定されている**
   - Vercel/Railwayなどの環境変数設定画面で確認

3. **データベースマイグレーションが実行されている**
   - 本番データベースに `push_subscriptions` と `user_push_subscriptions` テーブルが存在することを確認

4. **Service Workerがデプロイされている**
   - `dist/sw.js` が生成されていることを確認
   - 本番環境で `/sw.js` にアクセスしてファイルが返されることを確認

