# iOS SafariでのPWAインストール手順

## 問題の原因

iOS SafariでPWAをホーム画面に追加した際、意図したページではなく利用者アプリが表示される問題が発生する場合があります。これは以下の原因が考えられます：

1. **キャッシュの影響**: SafariのキャッシュやService Workerのキャッシュが古いデータを保持している
2. **manifest.jsonのキャッシュ**: iOSがmanifest.jsonをキャッシュしている
3. **インストール時のURLパス**: ホーム画面に追加した時点で表示していたページのURLが保存される

## キャッシュをクリアする手順

### 1. Safariのキャッシュと履歴をクリア

1. **設定**アプリを開く
2. **Safari**を選択
3. **履歴とWebサイトデータを消去**をタップ
4. 確認のメッセージが表示されたら、**履歴とデータを消去**を選択

これにより、Safariの閲覧履歴、キャッシュ、Cookieが削除されます。

### 2. ホーム画面から既存のPWAを削除

1. ホーム画面でPWAのアイコンを長押し
2. **削除**を選択
3. **ホーム画面から削除**を選択

### 3. Service Workerをクリア（開発者向け）

Safariの開発者メニューを使用する場合：

1. **設定** > **Safari** > **詳細** > **Webインスペクタ**を有効化
2. MacのSafariで**開発**メニューからデバイスを選択
3. **Service Worker**を選択して、登録されているService Workerを削除

## 店舗管理者アプリをホーム画面に追加する手順

### 手順1: 店舗管理者のログイン画面を開く

1. **Safari**を開く
2. 店舗管理者アプリのログイン画面のURLにアクセス
   - 例: `https://your-domain.com/shop-manager/login`
3. ページが完全に読み込まれるまで待つ
   - ページが完全に読み込まれたことを確認（ローディングインジケーターが消える）

### 手順2: ホーム画面に追加

1. 画面下部の**共有**ボタン（□↑アイコン）をタップ
2. 表示されるメニューから**ホーム画面に追加**を選択
   - メニューが表示されない場合は、上にスクロールして**ホーム画面に追加**を探す
3. 表示される画面で、アイコンの名前を確認
   - デフォルトでは「ふらのみ」と表示される
   - 必要に応じて「店舗管理」などに変更可能
4. **追加**をタップ

### 手順3: 動作確認

1. ホーム画面に追加されたアイコンをタップ
2. 店舗管理者のログイン画面が表示されることを確認
3. 利用者アプリ（`/user`）が表示される場合は、以下のトラブルシューティングを参照

## トラブルシューティング

### 問題1: ホーム画面から起動しても利用者アプリが表示される

**原因**: 
- キャッシュが古いデータを保持している
- インストール時に異なるページで「ホーム画面に追加」を実行した

**解決方法**:
1. 上記の「キャッシュをクリアする手順」を実行
2. 店舗管理者のログイン画面（`/shop-manager/login`）で再度「ホーム画面に追加」を実行

### 問題2: ホーム画面に追加できない

**原因**:
- Safari以外のブラウザを使用している
- iOSのバージョンが古い

**解決方法**:
1. **Safari**を使用していることを確認（Chromeなどでは動作しない）
2. iOSを最新バージョンにアップデート
3. **設定** > **Safari** > **詳細** > **JavaScript**が有効になっていることを確認

### 問題3: インストール後にページが正しく表示されない

**原因**:
- Service Workerが古いバージョンを保持している
- localStorageに古いデータが残っている

**解決方法**:
1. Safariのキャッシュをクリア（上記参照）
2. ホーム画面からPWAを削除して再インストール
3. ブラウザで直接URLにアクセスして、ページが正しく表示されることを確認

## 技術的な詳細

### インストール時のURLパス保存

アプリは、以下のタイミングでURLパスを`localStorage`に保存します：

1. **iOS Safari（通常のブラウザモード）**: ページが読み込まれるたびに、現在のURLパスをタイムスタンプ付きで保存
2. **Android/Chrome**: `beforeinstallprompt`イベントまたは`appinstalled`イベントでURLパスを保存

保存形式:
```json
{
  "path": "/shop-manager/login",
  "timestamp": 1234567890123
}
```

### PWA起動時のリダイレクト処理

PWA起動時（standaloneモード）にルート（`/`）にアクセスした場合：

1. `localStorage`から保存されたURLパスを取得
2. 24時間以内のパスのみ有効
3. 有効なパスがある場合、そのパスにリダイレクト
4. 有効なパスがない場合、デフォルトで`/user`にリダイレクト

### リダイレクトの判定条件

- `display-mode: standalone`が有効（PWAとして起動）
- `document.referrer`が空または異なるオリジン（PWA起動時）
- `window.location.pathname === '/'`（ルートにアクセス）

## 注意事項

- iOS Safariでは、`beforeinstallprompt`や`appinstalled`イベントが発火しないため、インストール時のURLパスを正確に検知できない
- そのため、ページが読み込まれるたびにURLパスを保存する方式を採用
- 最後にアクセスしたページのURLパスが保存されるため、インストール前に他のページにアクセスしないよう注意

## 参考情報

- [Apple公式: SafariでWebサイトをホーム画面に追加する](https://support.apple.com/ja-jp/HT201265)
- [MDN: Progressive Web Apps](https://developer.mozilla.org/ja/docs/Web/Progressive_web_apps)

